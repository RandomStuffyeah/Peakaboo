\documentclass[article,11pt]{report}



%Images
\usepackage[pdftex]{graphicx}

%In-document links
\usepackage[linktoc=all, colorlinks=true, linkcolor=blue]{hyperref}

%headers and footers
\usepackage{fancyhdr}
\usepackage{lastpage}

\usepackage[margin=1.4in]{geometry}



%text representing commands or in-program text
\newcommand{\command}[1]{\texttt{#1}}
%Place an icon inline with the text
\newcommand{\icon}[1]{\includegraphics[height=1em]{icons/#1.png}}
%Place and icon and command text together to represent a button
\newcommand{\button}[2]{\ \command{\icon{#1} #2}}
%Keyboard shortcut combining a modifier key and another key
\newcommand{\shortcut}[2]{\command{#1 + #2}}
%Menu chain
\newcommand{\menu}[0]{$\rightarrow$}

%element
\newcommand{\element}[1]{$#1$}

%emphasis
\newcommand{\emphasis}[1]{{\bf #1}}

%placing a screenshot as a figure
\newcommand{\screenshot}[2]{%
\begin{figure}[h!]
\centering\includegraphics[width=0.85\textwidth]{figures/#1.png}
\caption{#2}
\end{figure}
}


%Table of Contents macros
\newcommand{\tocchapter}[1]{\chapter*{#1}\addcontentsline{toc}{chapter}{#1}}
\newcommand{\tocsection}[1]{\section*{#1}\addcontentsline{toc}{section}{#1}}
\newcommand{\tocsubsection}[1]{\subsection*{#1}\addcontentsline{toc}{subsection}{#1}}
\newcommand{\tocsubsubsection}[1]{\subsubsection*{#1}\addcontentsline{toc}{subsubsection}{#1}}


\title{Peakaboo 4}
\date{March 6, 2012}
\author{Nathaniel Sherry, Marina Suominen Fuller}
        

\begin{document}

\renewcommand{\headrulewidth}{0pt}
\pagestyle{fancyplain}
\lhead[]{}
\rhead[]{}
%\rhead[\includegraphics[height=1em]{title/peakaboo.pdf}]{\includegraphics[height=1em]{title/peakaboo.pdf}}
\fancyhead[C]{\includegraphics[height=1em]{title/peakaboo.pdf}\ \includegraphics[height=1em]{title/usersguide.pdf}}


\begin{titlepage}
	\vspace*{\fill}
	\centering
	\includegraphics[height=4em]{title/peakaboo.pdf}\\
	\vspace*{1em}
	\includegraphics[height=1.5em]{title/usersguide.pdf}\\
	\vspace*{\fill}
	\vspace*{\fill}
\end{titlepage}

\newpage
\thispagestyle{empty}
\mbox{}
\setcounter{page}{0}

\tableofcontents



\tocchapter{Getting Started}


\tocsection{Opening Data}
Select \button{document-open}{Open} from the toolbar or 
\command{File \menu \button{document-open}{Open}} from the menu to locate your XRF scan files. 
You can browse your directories to find your data files. If all scanpoint data are 
contained in a single file, select it to open the file in the data directory. If 
there are many individual ``scanpoint'' files, locate them in the directory and 
use \shortcut{Control}{A} to select all of them to open.

\screenshot{open-files}{Peakaboo's File Selection Dialog}


\tocsection{Examining the Data}

The \icon{zoom-in} \icon{zoom-out} zoom slider bar on the bottom right of the window 
allows you to expand the x-axis (energy scale). You can use the scroll bar above
this area, click and drag on the spectrum itself, to pan back and forth to view 
different energy regions.

\screenshot{zoom-scroll}{Zoom Controls and Horizontal Scroll Bar}


\tocsection{Individual Scans}

The \command{Scan \#} field on the left side, under the spectrum view, allows you 
to view individual spectra in a map. Click on the arrows to move in the desired 
direction or enter a value and press \command{Enter}. This option will be disabled 
if you are viewing the mean average or strongest per channel composites rather than 
individual scans.

\screenshot{scan-number}{Scan Number Selector}


\tocsection{Energy Levels}

The \command{Max Energy} setting on the upper right provides energy calibration. 
If your dataset contains this value, the maximum energy value will be set 
automatically. If not, you will have to enter it manually. This value can be 
tweaked or adjusted by selecting a major element known or suspected to be present 
in the sample, and adjusting the energy range until the associated peak fits properly. 
First add your axes to the spectrum by selecting \command{View \menu\ Axes} from 
the menu. The Y Axis -- \command{Relative Intensity} and X Axis -- \command{Energy (keV)} should now be 
labeled for you.

\screenshot{max-energy}{The Maximum Energy Selector}

On the left side of the screen, under the \command{Peak Fitting} tab, click on the 
drop-down arrow beside the \button{edit-add}{Add Fittings} button and select 
\command{Elemental Lookup}, and a list of elements will become visible, 
listed in increasing atomic number. Find the element you wish to use as a reference, 
and click on the checkbox on the box next to it. A set of peaks will appear in shaded 
red within the spectrum. Adjust the Max Energy (keV) setting to move the red shaded 
peaks to fit these intense peaks in the spectrum. The Max Energy setting should now
be calibrated to your data.

You should double-check this Max Energy calibration by adding another element. Although
\element{Ar} may not be present in your sample, it typically appears in XRF spectra.
Select \element{Ar} from the peak list and the \element{Ar} K-$\alpha$ peak. It should appear 
at 2.95 keV with the accompanying K-$\beta$ peak. If you start adding element lines and the fits
appear off, check your calibration again.

\tocsection{Customizing the View}

The \command{View} menu contains many settings to help you to visualise the 
spectrum: \command{Logarithmic Scale} (usually best), \command{Axes} (shows energy 
and intensity scales), \command{Mean Average of Spectra} is the average of all scans 
(averages each energy channel across all spectra within a map to give you a much 
improved composite spectrum).

You can also add curve fitting markings to your spectrum: 
\command{View \menu\ Curve Fit \menu\ Element Names} to label each curve with the 
name of the element it represents,
\command{View \menu\ Curve Fit \menu\ Markings} showing transition markings (K-, L-lines), 
and \command{View \menu\ Curve Fit \menu\ Heights} for fitting heights (max counts).

Your spectrum, as it appears in the window, can also be saved by selecting 
\button{device-camera}{Export Plot as Image} from the toolbar, 
\command{File \menu\ Export Plot as Image}, or \shortcut{Control}{P}.  
Image format options include \command{PNG}, \command{SVG} or \command{PDF}. You can 
also save the fittings results as a txt file by selecting 
\command{File \menu \button{document-export}{Export Fittings as Text}}.

\tocsection{Saving and Loading Sessions}

You can save your session information, so that next time you want to look at your XRF 
data, you can just load this information (session) and not have to start from the 
beginning! These options are found under \command{File \menu \button{document-save}{Save Session}} 
and \command{File \menu\ Load Session}.




\tocchapter{Peak Fitting}

\tocsection{Escape Peaks}

Before doing any peak fitting, you should consider the type of
detector you used to collect the XRF spectra. Features may be present in your
spectra that are due to incoming X-rays interacting with the detector material. For
example, for a \element{Si} detector, there is a probability that some of the incoming X-rays
will interact with the \element{Si} and kick out \element{Si} K-shell electrons, thereby reducing the
incoming X-ray’s measured energy by 1.74 keV. This escape peak is present for the
major elements in the sample.

To include escape peaks in fitting the peaks in your spectra, select 
\command{View \menu\ Escape Peaks} and choose either \command{Silicon} or 
\command{Germanium}, depending on the type of detector you used. 
If you do not need to fit escape peaks, choose \command{None}.

\tocsection{Selecting Fittings}

There are three different tools which can be used to fit your data. To access these 
options, click on the drop-down arrow next to the \button{edit-add}{Add Fittings} button at 
the top of the \command{Peak Fitting} tab.


\tocsubsection{Guided Fitting}

This is the default option when clicking on \button{edit-add}{Add Fitting}. Click on the
peak you wish to fit and the program will fit the peak with a possible option. Click
\button{choose-ok}{OK} to add the lines to your list. Other possible element lines will also be
displayed in the drop down list. To add another fitting, click on the \button{edit-add}{Add} 
button below the current entry and click on another peak. To edit a previous fitting, 
click \button{edit-edit}{Edit}. Once you are happy with the fittings click
\button{choose-ok}{OK} to add the element lines to your list.

\screenshot{guided-fitting}{The Guided Fitting Controls}


\tocsubsection{Element Lookup}

Begin by adding elements from the lowest atomic number end first and working
your way up. It is recommended that you fit the K lines first. L lines for elements
for tungsten and higher should be fit separately from the K lines for lower atomic
number elements, as the K lines will interfere with the L line fittings. As you
select elements, their fittings will appear in red on the spectrum.

Once you are happy with the fittings, click \button{choose-ok}{OK}, and the
list of fitted elements will appear in black, with all the elements checked 
off in the boxes to the right of the element name. Toggling the check box to the
left of an element in the \command{Peak Fitting} panel will allow you to 
temporarily remove an elemental fitting from the fitting. Rechecking the box 
will put restore the fitting as it was.

\screenshot{lookup-fitting}{Elemental Fitting}

\tocsubsection{Summation Peaks}

If you are having trouble finding element lines to fit some peaks in your spectrum,
you may have what are called ‘pile-up peaks’ (referred to as ‘summation’ peaks in
Peakaboo). This is a detector phenomenon. If your sample has a lot of one element
present, then some of the emitted x-rays due to the presence of this element will
impinge on the detector virtually simultaneously and the pulse created and
measured would be the sum of the two x-ray energies. Please note that for element 
lines to appear in the drop down lists, they must have already been included in the 
spectral fit.


\tocchapter{Mapping}

To map the fitted elements, click on \button{map}{Map Fittings} in the toolbar. 
Click on the dropdown arrpw to the right of \button{map}{Map Fittings} to choose either the
fitting area (default) or fitting height for mapping. Only those checked fittings in your
\command{Fitted Elements} list will be mapped. It is recommended that you check all
fittings for mapping as each fitting results in an individual map which can be removed 
later. If your map is quite large, or you are using time-intensive filters, then it 
may be better to map fewer fittings at a time as the processing on your desktop or 
laptop will take considerable time.

Once you have clicked on \button{map}{Map Fittings}, a window will pop up indicating the
progress of mapping the fitted elements.

Once the mapping is complete, a window will appear with a coloured map, scale, and 
list of mapped element lines. For datasets which contain dimension information, map 
widths and heights are automatically set to appropriate values. Otherwise, the user 
must adjust the width and height. All fittings will be represented in the initial map. 
To get the individual element maps, uncheck all other fittings, leaving the element 
fitting you wish to view. If your maps have a pixilated appearance, you may want to 
try interpolating the data and using contouring.

if you wish to scale a fitting to its own highest intensity, select \command{Visible Fittings}
under the \command{Scale Intensities by:} section. If you choose the 
\command{All Fittings}, then the maps will be scaled to the highest intensity from 
the sum of all fittings. A minor element will show very a low intensity 
distribution with this latter option, but appear much more intense with the former.

Element line maps may be saved by clicking on the \button{device-camera}{Save Image} 
button on the toolbar or by selecting \command{Maps \menu\button{device-camera}{Save Image}}
from the menu. Various formats are available for saving your element line maps, 
Pixel Image (\command{PNG}), Vector Image (\command{SVG}) and \command{PDF} format.


\tocsection{Overlays}

The \command{Overlay} option for mapping is chosen from the drop down list under 
\command{Mapped Fittings}. This allows you to sort fittings into three groups: 
\command{Red}, \command{Blue}, \command{Green}. These groups are overlaid, with the
presence of each colour indicating the intensities of their fitting groups.

The \command{Scal Colours} options control the way that the fitting group's colours are scaled.
With the \command{As a Group} option, the highest intensity from \emphasis{all} 
groups of fittings is used to scale the intensities for \emphasis{every} group. With the 
\command{Separately} option, the highest intensity from \emphasis{within each} 
group of fittings is used to scale the intensities for that group. The \command{Separately}
option procuces maps which may be qualitatively interesting, but are quantitativly 
incorrect.

\tocsection{Ratios}

Mapping of element ratios is also available within Peakaboo. Select \command{Ratio} from the
\command{Mapped Fittings} dropdown list. Select the fittings (or fitting sets) you wish to
view in ratio and choose the desired colours from the dropdown lists next to each
fitting.

\tocsection{Errant Data}

Missing or skewed spectra within a data set can be removed from the map. To view the 
errant data point, make sure you are in ‘Individual Spectrum’ view in the main 
plotting window. Enter the \command{Index \#} you have determined the invalid 
data to be located at in the \command{Scan} field as shown. Click on the 
\button{choose-cancel}{Exclude} button as shown to flag the scan as bad to 
exclude it from the data set. In all future maps, this data point will be interpolated
from neighbouring data.


\tocsection{Plotting Subsections}

The distribution of elements will likely vary across your sample and hence your
maps. Peakaboo allows you to view spectra from selected regions within your map.
Left click and drag the mouse in order to draw a rectangle surrounding the region
you wish to select. Click on the down arrow to plot the selected region.

Another Peakaboo window will open up to display the spectra from the selected
region or subset. The spectra from the selected region or ‘subset’ can then be
processed with Peakaboo.


\tocchapter{Filters}

Filters can be accessed by clicking on the \command{Filters} tab and then clicking on 
\button{edit-add}{Add Filters} to display the available filters. Filters are grouped into
types. Each type heading can be expanded by clicking on the expander to the left of the filter 
type. Select the filter you wish to use and then click \button{choose-ok}{OK} 
to add the filter. Once you have added the filter, if you want to modify or check the 
parameters associated with your filter, click on the \button{misc-preferences}{Settings} 
button next to the filter name to bring up the filter settings window. As you change 
the parameters, you will see the changes reflected in the spectrum being displayed. Once 
you are satisfied with the filter settings, you may close the window.

The use of filters will obviously alter the spectrum. If you wish to see the raw data
outline, select \command{View \menu\ Raw Data Outline}.



\tocsection{Background Filters}

\tocsubsection{Polynomial}

This filter attempts to fit a series of parabolic (or higher order single-term) curves 
under the data, with a curve centred at each channel, and attempting to make each curve 
as tall as possible while still staying completely under the spectrum. The union of 
these curves is calculated and subtracted from the original data.

\tocsubsection{Brukner}

This filter removes background over several iterations by smoothing the data and 
taking the minimum of the unsmoothed and smoothed data for each channel on each pass.

\tocsubsection{Linear Trim}

This filter examins all pairs of points which are $n$ channels apart (ie (1, 10), 
(2, 11), \ldots\ where $n = 10$). For each pair of points, any signal which exceeds a straight 
line connecting the two points is truncated.

\tocsection{Noise Filters}

\tocsubsection{Savitsky-Golay}

This filter attempts to remove noise by fitting a polynomial to each
point $p_i$ and its surrounding points $p_{i-n} \ldots p_{i+n}$, and then taking the value of the
polynomial at $p_i$. A moving average may be considered a special case of this
filter with a polynomial of order 1.

\tocsubsection{Wavelet Low-Pass}

This filter attempts to reduce high-frequency noise by
performing a Wavelet transformation on the spectrum. This breaks the data down
into sections each representing a different frequency range. The high-frequency
regions are then smoothed, and a reverse transform is applied.

\tocsubsection{Aggressive Wavelet Low-Pass}

This filter attempts to reduce high-frequency noise by performing a wavelet 
transformation on the spectrum. This breaks the data down into sections each 
representing a different frequency range. The high-frequency regions are then 
completely removed, and a reverse transform is applied.

\tocsubsection{Fourier Low-Pass}

This filter transforms the spectral data with a Fourier Transformation into a 
frequency domain. Data from a high frequency range (noise) is filtered out, 
while lower frequencies (peaks, background) are passed through.

\tocsubsection{Moving Average}

This filter refines the values of each point in a scan by sampling it and the 
$n$ points to either side of it, and replacing it with an average of the sampled points.

\tocsubsection{Spring Smoothing}

This filter operates on the assumption that weak signal should be smoothed more 
than strong signal. It treats each pair of adjacent points as if they were
connected by a spring. With each iteration, a tension force draws neighbouring
points closer together. The \command{Force Multiplier} controls how strongly a 
pair of points are pulled together, and the \command{Force Falloff Rate} controls 
how aggressively stronger signal is anchored in place, unmoved by tension forces. 
This prevents stronger intensity such as peak shapes from being distorted by the smoothing 
algorithm.

\tocsection{Mathematical Filters}

\tocsubsection{Add}

This filter adds a constant value to all points on a spectrum.

\tocsubsection{Subtract}

This filter subtracts a constant value to all points on a spectrum.

\tocsubsection{Multiply}

This filter multiplies all points on a spectrum by a constant value.

\tocsubsection{Derivative}

This filter transforms the data such that each channel represents the
difference between itself and the channel before it.

\tocsubsection{Integral}

This filter transforms the data such that each channel represents the sum of
itself and all channels prior to it.


\tocsection{Advanced Filters}

\tocsubsection{Signal -> Wavelet}

This filter converts spectrum data into a wavelet representation. This is intended
to be used in conjunction with other filters (especially the \command{Filter Partial Spectrum}
filter) to perform custom wavelet operations.

\tocsubsection{Wavelet -> Signal}

This filter converts a wavelet representation of data back into
spectrum data. This is intended to be used in conjunction with other filters
(especially the \command{Filter Partial Spectrum} filter) to perform custom 
wavelet operations.

\tocsubsection{Normalizer}

This scales each spectrum so that the intensity at a specified channel is
always the same across all spectra.

\tocsubsection{Filter Partial Spectrum}

This filter allows the application of another filter to a portion of a spectrum.


\tocsection{Programming Filters}

\tocsubsection{Java Code}

This filter allows you to create your own filter in the Java programming language.

\tocsubsection{JPython Code}

This filter allows you to create your own filter in the Python programming language using JPython.

\end{document}

